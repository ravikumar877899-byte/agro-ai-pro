{% extends "base.html" %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <h1>Botanical Disease Encyclopedia</h1>
    <p style="color: var(--text-secondary);">A comprehensive knowledge base for crop pathology and health management.
    </p>
</div>

<div class="card" style="margin-bottom: 2rem;">
    <div style="display: flex; gap: 15px; align-items: center;">
        <i class="fa-solid fa-magnifying-glass" style="color: #666;"></i>
        <input type="text" id="cropSearch" placeholder="Search for a crop or disease (e.g., Tomato, Blight...)"
            onkeyup="searchCrops()">
    </div>
</div>

<div id="encyclopediaContent" class="grid">
    {% for crop, diseases in crop_library.items() %}
    <div class="card crop-section" data-crop="{{ crop.lower() }}">
        <div
            style="display: flex; align-items: center; gap: 15px; margin-bottom: 1.5rem; border-bottom: 2px solid #f1f8e9; padding-bottom: 10px;">
            <i class="fa-solid fa-seedling" style="color: var(--primary-color); font-size: 1.8rem;"></i>
            <h2 style="text-transform: capitalize;">{{ crop }}</h2>
        </div>

        <ul style="list-style: none;">
            {% for item in diseases %}
            <li class="disease-item {{ 'border-healthy' if 'healthy' in item.id.lower() else 'border-diseased' }}"
                data-disease="{{ item.data.name.lower() }}" data-type="{{ item.data.type.lower() }}"
                data-symptoms="{{ item.data.symptoms.lower() }}"
                style="margin-bottom: 1.5rem; padding: 1rem; background: #fafafa; border-radius: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <strong style="font-size: 1.1rem;">{{ item.data.name }}</strong>
                    <span
                        class="{{ 'bg-healthy text-healthy' if 'healthy' in item.id.lower() else 'bg-diseased text-diseased' }}"
                        style="font-size: 0.75rem; font-weight: bold; padding: 3px 8px; border-radius: 10px;">
                        {{ item.data.type }}
                    </span>
                </div>
                <p style="font-size: 0.85rem; color: #666; line-height: 1.4;">{{ item.data.symptoms }}</p>
                <div style="margin-top: 10px; display: flex; gap: 10px;">
                    <a href="{{ url_for('treatment') }}#{{ item.id.replace(' ', '_') }}" class="btn"
                        style="padding: 5px 12px; font-size: 0.75rem; border-radius: 5px;">View Treatment</a>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endfor %}
    <div id="noResults" class="card"
        style="display: none; width: 100%; grid-column: 1 / -1; text-align: center; padding: 3rem;">
        <i class="fa-solid fa-magnifying-glass-chart" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;"></i>
        <h3 style="color: #888;">No matches found</h3>
        <p style="color: #aaa;">Try adjusting your search terms for crops, diseases, or symptoms.</p>
    </div>
</div>

<script>
    function searchCrops() {
        let input = document.getElementById('cropSearch').value.toLowerCase();
        let sections = document.getElementsByClassName('crop-section');
        let noResults = document.getElementById('noResults');
        let totalVisibleInAll = 0;

        for (let section of sections) {
            let cropName = section.getAttribute('data-crop');
            let diseases = section.getElementsByClassName('disease-item');
            let hasVisibleDisease = false;

            for (let disease of diseases) {
                let diseaseName = disease.getAttribute('data-disease');
                let diseaseType = disease.getAttribute('data-type');
                let symptoms = disease.getAttribute('data-symptoms');

                if (cropName.includes(input) ||
                    diseaseName.includes(input) ||
                    diseaseType.includes(input) ||
                    symptoms.includes(input)) {
                    disease.style.display = "";
                    hasVisibleDisease = true;
                    totalVisibleInAll++;
                } else {
                    disease.style.display = "none";
                }
            }

            if (hasVisibleDisease) {
                section.style.display = "";
            } else {
                section.style.display = "none";
            }
        }

        noResults.style.display = (totalVisibleInAll === 0 && input !== "") ? "block" : "none";
    }
</script>
{% endblock %}